<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>x86 性能优化 | Peng Du</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="x86 性能优化">
<meta property="og:type" content="article">
<meta property="og:title" content="x86 性能优化">
<meta property="og:url" content="http://example.com/2020/09/14/2020-09-29-x86opt/index.html">
<meta property="og:site_name" content="Peng Du">
<meta property="og:description" content="x86 性能优化">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gizejei985j30di087ab3.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gizeomz44aj313f0a1jrf.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gittqhhiukj30oc0yqalv.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gizeo1cekqj31400b8jrk.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gitwe2gih2j31900oq10w.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gitx4jlvr7j31e60jo7af.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gitdwuf5kuj30wa0i840e.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gitt6qagcoj30su13qgyf.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gitt6q0acdj31280kcq5o.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gitt6pn2r0j312g0tcqeg.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1giw8n9u48kj310o0n2abm.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1giyjbzzakfj30y60j279i.jpg">
<meta property="article:published_time" content="2020-09-14T01:54:51.237Z">
<meta property="article:modified_time" content="2020-09-29T10:51:13.599Z">
<meta property="article:author" content="Peng Du">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gizejei985j30di087ab3.jpg">
  
    <link rel="alternate" href="/atom.xml" title="Peng Du" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Peng Du</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2020-09-29-x86opt" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/14/2020-09-29-x86opt/" class="article-date">
  <time datetime="2020-09-14T01:54:51.237Z" itemprop="datePublished">2020-09-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      x86 性能优化
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>x86 性能优化</p>
<a id="more"></a>

<h1 id="x86性能优化"><a href="#x86性能优化" class="headerlink" title="x86性能优化"></a>x86性能优化</h1><h2 id="CPU架构"><a href="#CPU架构" class="headerlink" title="- CPU架构"></a>- CPU架构</h2><h2 id="x86汇编和SIMD指令"><a href="#x86汇编和SIMD指令" class="headerlink" title="- x86汇编和SIMD指令"></a>- x86汇编和SIMD指令</h2><h2 id="工具和参考资料"><a href="#工具和参考资料" class="headerlink" title="- 工具和参考资料"></a>- 工具和参考资料</h2><hr>
<h2 id="CPU简化图"><a href="#CPU简化图" class="headerlink" title="CPU简化图"></a>CPU简化图</h2><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gizejei985j30di087ab3.jpg"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gizeomz44aj313f0a1jrf.jpg"></p>
<h2 id="X86处理器结构图"><a href="#X86处理器结构图" class="headerlink" title="X86处理器结构图"></a>X86处理器结构图</h2><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gittqhhiukj30oc0yqalv.jpg"></p>
<ul>
<li>流水线<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gizeo1cekqj31400b8jrk.jpg"></li>
<li>分支预测BPU</li>
<li>复杂指令被拆分成uops</li>
<li>若干个decode单元</li>
<li>若干个执行单元</li>
<li>多发射，乱序执行</li>
<li>寄存器重命名消除依赖<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mov eax, [mem1]        mov eax, [mem1]</span><br><span class="line">imul eax, 6            imul eax, 6</span><br><span class="line">mov [mem2], eax        mov [mem2], eax</span><br><span class="line">mov  ebx, [mem3]       mov  eax, [mem3]; cpu给eax分配一个物理寄存器，消除前后指令对于eax的依赖</span><br><span class="line">add  ebx, 2            add  eax, 2</span><br><span class="line">mov  [mem4], ebx       mov  [mem4], eax</span><br></pre></td></tr></table></figure>

</li>
</ul>
<hr>
<h2 id="优化基本原则"><a href="#优化基本原则" class="headerlink" title="优化基本原则"></a>优化基本原则</h2><ul>
<li><p>尽量使用简单指令，复杂指令解码器只有一个</p>
</li>
<li><p>使用延时小，吞吐量高的指令<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gitwe2gih2j31900oq10w.jpg"></p>
<ul>
<li>避免除法</li>
<li>避免浮点计算</li>
<li>使用shift替代乘法除法</li>
</ul>
</li>
<li><p>减少分支跳转。分支预测失败造成性能损失（20-50cycles）。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">; if (b &gt; a) b &#x3D; a</span><br><span class="line">sub eax, ebx ; &#x3D; a-b</span><br><span class="line">sbb edx,edx  ;&#x3D;(b&gt;a)?0xFFFFFFFF:0</span><br><span class="line">and edx,eax  ;&#x3D;(b&gt;a)?a-b:0</span><br><span class="line">add ebx, edx ; Result is in ebx</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用likely告诉编译器，func()的二进制尽量靠近调用，提高cache命中率</span></span><br><span class="line"><span class="keyword">if</span> (likely(value)) &#123;</span><br><span class="line">  func();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>尽量使前后若干条指令走不同port，使用不同的执行单元<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gitx4jlvr7j31e60jo7af.jpg"></li>
<li>打断前后计算的依赖<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">优化前</span><br><span class="line"><span class="keyword">float</span> a, b, c, d, y; y = a + b + c + d;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">优化后</span><br><span class="line"><span class="keyword">float</span> a, b, c, d, y;</span><br><span class="line">y = (a + b) + (c + d);</span><br><span class="line">a + b, c + d可独立计算</span><br></pre></td></tr></table></figure></li>
<li>数据对齐<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__declspec(align(<span class="number">16</span>))</span><br><span class="line">__attribute__((aligned(<span class="number">16</span>)))</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Motion vector cache.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">DECLARE_ALIGNED(<span class="number">16</span>, <span class="keyword">int16_t</span>, mv_cache)[<span class="number">2</span>][<span class="number">5</span> * <span class="number">8</span>][<span class="number">2</span>];</span><br><span class="line">DECLARE_ALIGNED(<span class="number">8</span>, <span class="keyword">int8_t</span>, ref_cache)[<span class="number">2</span>][<span class="number">5</span> * <span class="number">8</span>];</span><br><span class="line">DECLARE_ALIGNED(<span class="number">16</span>, <span class="keyword">uint8_t</span>, mvd_cache)[<span class="number">2</span>][<span class="number">5</span> * <span class="number">8</span>][<span class="number">2</span>];</span><br><span class="line"><span class="keyword">uint8_t</span> direct_cache[<span class="number">5</span> * <span class="number">8</span>];</span><br></pre></td></tr></table></figure>

</li>
</ul>
<hr>
<h2 id="X86寄存器"><a href="#X86寄存器" class="headerlink" title="X86寄存器"></a>X86寄存器</h2><h3 id="通用寄存器"><a href="#通用寄存器" class="headerlink" title="通用寄存器"></a>通用寄存器</h3><table>
<thead>
<tr>
<th>bit 0 - 63</th>
<th>bit 0 - 31</th>
<th>bit 0 - 15</th>
<th>bit8-15</th>
<th>bit 0 - 7</th>
</tr>
</thead>
<tbody><tr>
<td>RAX</td>
<td>EAX</td>
<td>AX</td>
<td>AH</td>
<td>AL</td>
</tr>
<tr>
<td>RBX</td>
<td>EBX</td>
<td>BX</td>
<td>BH</td>
<td>BL</td>
</tr>
<tr>
<td>RCX</td>
<td>ECX</td>
<td>CX</td>
<td>CH</td>
<td>CL</td>
</tr>
<tr>
<td>RDX</td>
<td>EDX</td>
<td>DX</td>
<td>DH</td>
<td>DL</td>
</tr>
<tr>
<td>RSI</td>
<td>ESI</td>
<td>SI</td>
<td></td>
<td></td>
</tr>
<tr>
<td>RDI</td>
<td>EDI</td>
<td>DI</td>
<td></td>
<td></td>
</tr>
<tr>
<td>RBP</td>
<td>EBP</td>
<td>BP</td>
<td></td>
<td></td>
</tr>
<tr>
<td>RSP</td>
<td>ESP</td>
<td>SP</td>
<td></td>
<td></td>
</tr>
<tr>
<td>RFlags</td>
<td>EFlags</td>
<td>Flags</td>
<td></td>
<td></td>
</tr>
<tr>
<td>RIP</td>
<td>EIP</td>
<td>IP</td>
<td></td>
<td></td>
</tr>
<tr>
<td>R8-R15</td>
<td>R8D-R15D</td>
<td>R8W-R15W</td>
<td></td>
<td>R8B-R15B</td>
</tr>
</tbody></table>
<p>⚠️ R8-R15仅存在于64位CPU上</p>
<hr>
<h3 id="浮点寄存器和64bit向量寄存器"><a href="#浮点寄存器和64bit向量寄存器" class="headerlink" title="浮点寄存器和64bit向量寄存器"></a>浮点寄存器和64bit向量寄存器</h3><table>
<thead>
<tr>
<th>bit 0 - 79</th>
<th>bit 0 - 63</th>
</tr>
</thead>
<tbody><tr>
<td>ST(0)</td>
<td>MM0</td>
</tr>
<tr>
<td>ST(1)</td>
<td>MM1</td>
</tr>
<tr>
<td>ST(2)</td>
<td>MM2</td>
</tr>
<tr>
<td>ST(3)</td>
<td>MM3</td>
</tr>
<tr>
<td>ST(4)</td>
<td>MM4</td>
</tr>
<tr>
<td>ST(5)</td>
<td>MM5</td>
</tr>
<tr>
<td>ST(6)</td>
<td>MM6</td>
</tr>
<tr>
<td>ST(7)</td>
<td>MM7</td>
</tr>
</tbody></table>
<hr>
<h3 id="向量寄存器"><a href="#向量寄存器" class="headerlink" title="向量寄存器"></a>向量寄存器</h3><table>
<thead>
<tr>
<th>bit 0 - 128</th>
<th>bit 0 - 255</th>
<th>bit 0 - 511</th>
</tr>
</thead>
<tbody><tr>
<td>XMM0</td>
<td>YMM0</td>
<td>ZMM0</td>
</tr>
<tr>
<td>XMM1</td>
<td>YMM1</td>
<td>ZMM1</td>
</tr>
<tr>
<td>XMM2</td>
<td>YMM2</td>
<td>ZMM2</td>
</tr>
<tr>
<td>XMM3</td>
<td>YMM3</td>
<td>ZMM3</td>
</tr>
<tr>
<td>XMM4</td>
<td>YMM4</td>
<td>ZMM4</td>
</tr>
<tr>
<td>XMM5</td>
<td>YMM5</td>
<td>ZMM5</td>
</tr>
<tr>
<td>XMM6</td>
<td>YMM6</td>
<td>ZMM6</td>
</tr>
<tr>
<td>XMM7</td>
<td>YMM7</td>
<td>ZMM7</td>
</tr>
<tr>
<td>XMM8</td>
<td>YMM8</td>
<td>ZMM8</td>
</tr>
<tr>
<td>XMM9</td>
<td>YMM9</td>
<td>ZMM9</td>
</tr>
<tr>
<td>XMM10</td>
<td>YMM10</td>
<td>ZMM10</td>
</tr>
<tr>
<td>XMM11</td>
<td>YMM11</td>
<td>ZMM11</td>
</tr>
<tr>
<td>XMM12</td>
<td>YMM12</td>
<td>ZMM12</td>
</tr>
<tr>
<td>XMM13</td>
<td>YMM13</td>
<td>ZMM13</td>
</tr>
<tr>
<td>XMM14</td>
<td>YMM14</td>
<td>ZMM14</td>
</tr>
<tr>
<td>XMM15</td>
<td>YMM15</td>
<td>ZMM15</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ZMM16</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ZMM17</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ZMM18</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ZMM19</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ZMM20</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ZMM21</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ZMM22</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ZMM23</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ZMM24</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ZMM25</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ZMM26</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ZMM27</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ZMM28</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ZMM29</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ZMM30</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ZMM31</td>
</tr>
</tbody></table>
<p>⚠️ 32位CPU上仅存在XMM0-XMM7，YMM0-YMM7，ZMM0-ZMM7</p>
<hr>
<h2 id="汇编开发方式"><a href="#汇编开发方式" class="headerlink" title="汇编开发方式"></a>汇编开发方式</h2><h3 id="内联汇编"><a href="#内联汇编" class="headerlink" title="内联汇编"></a>内联汇编</h3><p>优点</p>
<ul>
<li>直接访问c/c++变量</li>
<li>快速针对局部代码进行优化<br>缺点</li>
<li>没有宏</li>
<li>格式不统一，intel/AT&amp;T</li>
</ul>
<table>
<thead>
<tr>
<th>Intel Code</th>
<th>AT&amp;T Code</th>
</tr>
</thead>
<tbody><tr>
<td>mov eax,1</td>
<td>movl $1,%eax</td>
</tr>
<tr>
<td>mov ebx,0ffh</td>
<td>movl $0xff,%ebx</td>
</tr>
<tr>
<td>int 80h</td>
<td>int $0x80</td>
</tr>
<tr>
<td>mov ebx, eax</td>
<td>movl %eax, %ebx</td>
</tr>
<tr>
<td>mov eax,[ecx]</td>
<td>movl (%ecx),%eax</td>
</tr>
<tr>
<td>mov eax,[ebx+3]</td>
<td>movl 3(%ebx),%eax</td>
</tr>
<tr>
<td>mov eax,[ebx+20h]</td>
<td>movl 0x20(%ebx),%eax</td>
</tr>
<tr>
<td>add eax,[ebx+ecx*2h]</td>
<td>addl (%ebx,%ecx,0x2),%eax</td>
</tr>
<tr>
<td>lea eax,[ebx+ecx]    l eal</td>
<td>(%ebx,%ecx),%eax</td>
</tr>
<tr>
<td>sub eax,[ebx+ecx*4h-20h]</td>
<td>subl -0x20(%ebx,%ecx,0x4),%eax</td>
</tr>
</tbody></table>
<p>AT&amp;T格式</p>
<ul>
<li>每条指令放在一个双引号内，或者将所有的指令都放着一个双引号内。</li>
<li>每条指令都要包含一个分隔符。合法的分隔符是换行符(\n)或者分号。用换行符的时候通常后面放一个制表符\t。对此前文已经有所说明。</li>
<li>访问C语言变量用%0,%1…等等。</li>
</ul>
<p>Intel</p>
<ul>
<li>可以直接使用数组地址</li>
</ul>
<hr>
<h3 id="Intrinsics"><a href="#Intrinsics" class="headerlink" title="Intrinsics"></a>Intrinsics</h3><p>优点</p>
<ul>
<li>像调函数一样使用指令，易上手</li>
</ul>
<p>缺点</p>
<ul>
<li>无法精确控制数据的load/save，可能造成额外的开销</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;xmmintrin.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">float</span> *a, <span class="keyword">float</span> *b, <span class="keyword">float</span> *c)</span> </span>&#123;</span><br><span class="line">  __m128 t0, t1;</span><br><span class="line">  t0 = _mm_load_ps(a);</span><br><span class="line">  t1 = _mm_load_ps(b);</span><br><span class="line">  t0 = _mm_add_ps(t0, t1);</span><br><span class="line">  _mm_store_ps(c, t0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="nasm汇编"><a href="#nasm汇编" class="headerlink" title="nasm汇编"></a>nasm汇编</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">; -----------------------------------------------------------------------------</span><br><span class="line">; 一个输出 Fibonacci 数列前 90 项的 64 位 Linux 程序。</span><br><span class="line">; 如何编译执行:</span><br><span class="line">;</span><br><span class="line">;     nasm -felf64 fib.asm &amp;&amp; gcc fib.o &amp;&amp; .&#x2F;a.out</span><br><span class="line">; -----------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">        global  main</span><br><span class="line">        extern  printf</span><br><span class="line"></span><br><span class="line">        section .text</span><br><span class="line">main:</span><br><span class="line">        push    rbx                     ; 因为需要用 rbx 寄存器所以需要保存</span><br><span class="line"></span><br><span class="line">        mov     ecx, 90                 ; ecx 作为计数器直至减到 0</span><br><span class="line">        xor     rax, rax                ; rax 将记录当前的数字</span><br><span class="line">        xor     rbx, rbx                ; rbx 将记录下一个的数字</span><br><span class="line">        inc     rbx                     ; rbx 初始值 1</span><br><span class="line">print:</span><br><span class="line">        ; 我们需要调用 printf 函数, 但是我们也同时在使用 rax,rbx 和 rcx 这三个寄存器。</span><br><span class="line">        ; 调用 printf 函数会破坏 rax 和 rcx 这两个寄存器的值, 所以我们要在调用前保存</span><br><span class="line">        ; 并且在调用后恢复这两个寄存器中的数据。</span><br><span class="line"></span><br><span class="line">        push    rax                     ; 调用者保存寄存器</span><br><span class="line">        push    rcx                     ; 调用者保存寄存器</span><br><span class="line"></span><br><span class="line">        mov     rdi, format             ; 设置第一个参数 (format)</span><br><span class="line">        mov     rsi, rax                ; 设置第二个参数 (current_number)</span><br><span class="line">        xor     rax, rax                ; 因为 printf 是多参数的</span><br><span class="line"></span><br><span class="line">        ; 栈内已经对齐, 因为我们压入了三个 8 字节的数据。</span><br><span class="line">        call    printf                  ; printf(format, current_number)</span><br><span class="line"></span><br><span class="line">        pop     rcx                     ; 恢复调用者所保存的寄存器</span><br><span class="line">        pop     rax                     ; 恢复调用者所保存的寄存器</span><br><span class="line"></span><br><span class="line">        mov     rdx, rax                ; 保存当前的数字</span><br><span class="line">        mov     rax, rbx                ; 下一个数字保存在当前数字的位置</span><br><span class="line">        add     rbx, rdx                ; 计算得到下一个数字</span><br><span class="line">        dec     ecx                     ; ecx 减 1</span><br><span class="line">        jnz     print                   ; 如果不是 0, 继续循环</span><br><span class="line"></span><br><span class="line">        pop     rbx                     ; 返回前恢复 rbx 的值</span><br><span class="line">        ret</span><br><span class="line">format:</span><br><span class="line">        db  &quot;%20ld&quot;, 10, 0</span><br></pre></td></tr></table></figure>
<p>多行宏<br>%macro 宏名 1-4 参数名列表<br>宏体<br>%endmacro<br>%0为参数个数 %?为宏名</p>
<p>%macro  multipush 1-*<br>%rep  %0<br>        push    %1<br>        %rotate 1<br>%endrep<br>%endmacro</p>
<p>%define 单行<br>%assign 定义常数</p>
<p>%if<condition><br>; some code which only appears if <condition> is met<br>%elif<condition2><br>; only appears if <condition> is not met but <condition2> is<br>%else<br>; this appears if neither <condition> nor <condition2> was met<br>%endif</p>
<h2 id="macro的奇技淫巧参见x86inc-asm和x86util-asm"><a href="#macro的奇技淫巧参见x86inc-asm和x86util-asm" class="headerlink" title="macro的奇技淫巧参见x86inc.asm和x86util.asm"></a>macro的奇技淫巧参见x86inc.asm和x86util.asm</h2><hr>
<h2 id="SIMD发展历史"><a href="#SIMD发展历史" class="headerlink" title="SIMD发展历史"></a>SIMD发展历史</h2><h3 id="MMX™-1996-Intel®-Pentium-Pentium®-with-MMX™-and-Pentium-with-MMX™-and-Pentium®-II-processors-processors"><a href="#MMX™-1996-Intel®-Pentium-Pentium®-with-MMX™-and-Pentium-with-MMX™-and-Pentium®-II-processors-processors" class="headerlink" title="MMX™ 1996 - Intel® Pentium Pentium® with MMX™ and Pentium with MMX™ and Pentium® II processors processors"></a>MMX™ 1996 - Intel® Pentium Pentium® with MMX™ and Pentium with MMX™ and Pentium® II processors processors</h3><ul>
<li>Introduced 64-bit MMX registers for SIMD integer operations</li>
<li>Supports SIMD operations on packed byte word and double Supports SIMD operations on packed byte, word, and double-word integers word integers</li>
<li>Useful for multimedia and communications software</li>
</ul>
<h3 id="SSE-Streaming-SIMD-extensions-1999-–-Intel®-Pentium-Pentium®-III-processor-III-processor"><a href="#SSE-Streaming-SIMD-extensions-1999-–-Intel®-Pentium-Pentium®-III-processor-III-processor" class="headerlink" title="SSE(Streaming SIMD extensions) 1999 – Intel® Pentium Pentium® III processor III processor"></a>SSE(Streaming SIMD extensions) 1999 – Intel® Pentium Pentium® III processor III processor</h3><ul>
<li>Introduced 128 Introduced 128-bit extended memory manager (XMM) registers for SIMD integers and FP-SP operands</li>
<li>Executes FP and SIMD simultaneously</li>
<li>Introduced data prefetch instructions</li>
<li>Useful for 3D g y, g, g/ g eometry, 3D rendering, and video encoding/decoding</li>
</ul>
<h3 id="SSE2-2000-–-Intel®-Pentium-Pentium®-4-and-Intel-4-and-Intel®-Xeon-processors-™-processors"><a href="#SSE2-2000-–-Intel®-Pentium-Pentium®-4-and-Intel-4-and-Intel®-Xeon-processors-™-processors" class="headerlink" title="SSE2 2000 – Intel® Pentium Pentium® 4 and Intel 4 and Intel® Xeon processors ™ processors"></a>SSE2 2000 – Intel® Pentium Pentium® 4 and Intel 4 and Intel® Xeon processors ™ processors</h3><ul>
<li>Added extra 64-bit SIMD integ pp er support</li>
<li>Has same XMM reg g gp p ( isters for SIMD integer and floating point double precision (FP-DP)</li>
<li>Has 144 new instructions for data support (no new registers)</li>
<li>Adds support for cacheability and memory ordering operations</li>
<li>Useful for 3D graphics, video encoding/decoding and encryption</li>
</ul>
<h3 id="SSE3-2004-–-Intel®-Pentium®-4-Processor"><a href="#SSE3-2004-–-Intel®-Pentium®-4-Processor" class="headerlink" title="SSE3 2004 – Intel® Pentium® 4 Processor"></a>SSE3 2004 – Intel® Pentium® 4 Processor</h3><ul>
<li>Accelerates performance of Streaming SIMD Extensions technology, Streaming SIMD Extensions 2 technology and X87 technology, and X87-FP math capabilities.</li>
<li>Useful in some 3D operations (Quaternions) complex arithmetic and video codec algorithms Useful in some 3D operations (Quaternions), complex arithmetic and video codec algorithms</li>
</ul>
<h3 id="SSSE3-2006-–-Itl-n-e-®-Core®-2-Processor"><a href="#SSSE3-2006-–-Itl-n-e-®-Core®-2-Processor" class="headerlink" title="SSSE3 2006 – Itl n e ® Core® 2 Processor"></a>SSSE3 2006 – Itl n e ® Core® 2 Processor</h3><ul>
<li>application performance improvement.</li>
<li>potential for specifc application domains</li>
</ul>
<h3 id="SSE4-2007"><a href="#SSE4-2007" class="headerlink" title="SSE4 2007"></a>SSE4 2007</h3><ul>
<li>Efficient Accelerated String and Text Processing.</li>
</ul>
<h3 id="AVX-Advance-vector-extensions-2011-2nd-and-3rd-generation-Intel®-Core™-Processors"><a href="#AVX-Advance-vector-extensions-2011-2nd-and-3rd-generation-Intel®-Core™-Processors" class="headerlink" title="AVX(Advance vector extensions) 2011 - 2nd and 3rd generation Intel® Core™ Processors"></a>AVX(Advance vector extensions) 2011 - 2nd and 3rd generation Intel® Core™ Processors</h3><ul>
<li>Introduced 256 bit registers YMM</li>
<li>Flexible unaligned memory access support</li>
</ul>
<h3 id="AVX2-2013-4th-generation-Intel®-Core™-Processors"><a href="#AVX2-2013-4th-generation-Intel®-Core™-Processors" class="headerlink" title="AVX2 2013 - 4th generation Intel® Core™ Processors"></a>AVX2 2013 - 4th generation Intel® Core™ Processors</h3><ul>
<li>Vector-vector shifts</li>
<li>Bit Manipulation Instructions (BMI)<h2 id="AVX512-2016"><a href="#AVX512-2016" class="headerlink" title="AVX512 2016"></a>AVX512 2016</h2></li>
<li>Introduced 512 bit registers ZMM</li>
<li>512 bit vector instruction set extension</li>
</ul>
<hr>
<h2 id="SIMD数据类型"><a href="#SIMD数据类型" class="headerlink" title="SIMD数据类型"></a>SIMD数据类型</h2><h3 id="64位SIMD数据"><a href="#64位SIMD数据" class="headerlink" title="64位SIMD数据"></a>64位SIMD数据</h3><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gitdwuf5kuj30wa0i840e.jpg"></p>
<hr>
<h2 id="SIMD指令"><a href="#SIMD指令" class="headerlink" title="SIMD指令"></a>SIMD指令</h2><h3 id="Packed-Arithmetic"><a href="#Packed-Arithmetic" class="headerlink" title="Packed Arithmetic"></a>Packed Arithmetic</h3><p>paddb[w|d|q|sb|usb]</p>
<ul>
<li>p packed</li>
<li>b byte; w 2bytes; d 4bytes; q 8bytes</li>
<li>u unsigned byte integers</li>
<li>s saturation</li>
</ul>
<hr>
<h3 id="Comparison"><a href="#Comparison" class="headerlink" title="Comparison"></a>Comparison</h3><p>Intel/AMD Mnemonic | Description<br>|—–|——|<br>PCMPEQB mm, mm/m64    |    Compare packed bytes for equality<br>PCMPEQW mm, mm/m64    |    Compare packed words for equality<br>PCMPEQD mm, mm/m64    |    Compare packed doublewords for equality<br>PCMPGTB mm, mm/m64    |    Compare packed signed byte integers for greater than<br>PCMPGTW mm, mm/m64    |    Compare packed signed word integers for greater than<br>PCMPGTD mm, mm/m64    |    Compare packed signed doubleword integers for greater than</p>
<hr>
<h3 id="Conversion"><a href="#Conversion" class="headerlink" title="Conversion"></a>Conversion</h3><p>Intel/AMD Mnemonic | Description<br>|—–|——|<br>PACKSSDW | pack doublewords into words with signed saturation<br>PACKSSWB |pack words into bytes with signed saturation<br>PACKUSWB |pack words into bytes with unsigned saturation<br>PUNPCKHBW | unpack high-order bytes<br>PUNPCKHDQ |unpack high-order doublewords<br>PUNPCKHWD | unpack high-order words<br>PUNPCKLBW |unpack low-order bytes<br>PUNPCKLDQ |unpack low-order doublewords<br>PUNPCKLWD |unpack low-order words</p>
<hr>
<h3 id="Data-Transfer-Instructions"><a href="#Data-Transfer-Instructions" class="headerlink" title="Data Transfer Instructions"></a>Data Transfer Instructions</h3><p>Intel/AMD Mnemonic | Description<br>|—–|——|<br>MOVD mm, r/m32    |    Move doubleword<br>MOVD r/m32, mm    |    Move doubleword<br>MOVQ mm/m64, mm    |    Move quadword<br>MOVQ mm, mm/m64    |    Move quadword<br>MOVQ mm, r/m64    |    Move quadword<br>MOVQ r/m64, mm    |    Move quadword<br>MOVDQ2Q mm, xmm | move quadword integer from XMM to MMX registers<br>MOVDQA xmm1, xmm2/m128    |    Move aligned double quadword<br>MOVDQA xmm2/m128, xmm1    |    Move aligned double quadword<br>MOVDQU xmm1, xmm2/m128    |    Move unaligned double quadword<br>MOVDQU xmm2/m128, xmm1    |    Move unaligned double quadword<br>MOVQ2DQ xmm, mm    |    Move quadword from MMX register to low quadword of XMM register<br>LDDQU xmm1, mem | Load unaligned data and return double quadword</p>
<hr>
<h3 id="Logic-Instructions"><a href="#Logic-Instructions" class="headerlink" title="Logic Instructions"></a>Logic Instructions</h3><p>Intel/AMD Mnemonic | Description<br>|—–|——|<br>PAND mm, mm/m64    |    Bitwise AND<br>PANDN mm, mm/m64    |    Bitwise AND NOT<br>POR mm, mm/m64    |    Bitwise OR<br>PXOR mm, mm/m64    |    Bitwise XOR</p>
<hr>
<h3 id="Shift-and-Rotate"><a href="#Shift-and-Rotate" class="headerlink" title="Shift and Rotate"></a>Shift and Rotate</h3><p>用来替代2的乘法和除法</p>
<p>Intel/AMD Mnemonic | Description<br>|—–|——|<br>PSLLD |shift packed doublewords left logical<br>PSLLQ |shift packed quadword left logical<br>PSLLW |shift packed words left logical<br>PSRAD |shift packed doublewords right arithmetic<br>PSRAW |shift packed words right arithmetic<br>PSRLD |shift packed doublewords right logical<br>PSRLQ |shift packed quadword right logical<br>PSRLW |shift packed words right logical</p>
<hr>
<h3 id="shuffle"><a href="#shuffle" class="headerlink" title="shuffle"></a>shuffle</h3><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gitt6qagcoj30su13qgyf.jpg" alt="broadcast"><br><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gitt6q0acdj31280kcq5o.jpg" alt="reverse"><br><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gitt6pn2r0j312g0tcqeg.jpg" alt="rotate"></p>
<hr>
<h2 id="常用汇编snippet"><a href="#常用汇编snippet" class="headerlink" title="常用汇编snippet"></a>常用汇编snippet</h2><h3 id="产生常数向量"><a href="#产生常数向量" class="headerlink" title="产生常数向量"></a>产生常数向量</h3><p>优点，执行时间固定。从内存load常量数据，如果cache命中了数据，速度也不慢，如果数据不在cache中，需要从memory读入，速度就慢很多</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pxor mm0, mm0   ; generate a zero register in MM0</span><br><span class="line">pcmpeq mm1, mm1 ; Generate all 1&#39;s in register MM1, which is -1 in each of the packed data type fields</span><br><span class="line"></span><br><span class="line">psubb mm0, mm1 [psubw mm0, mm1] (psubd mm0, mm1)</span><br><span class="line">psrlw mm1, 16-n(psrld mm1, 32-n)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="无符号数绝对值差"><a href="#无符号数绝对值差" class="headerlink" title="无符号数绝对值差"></a>无符号数绝对值差</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">movq mm2, mm0     ; make a copy of mm0</span><br><span class="line">psubusb mm0, mm1  ; compute difference one way</span><br><span class="line">psubusb mm1, mm2  ; compute difference the other way</span><br><span class="line">por mm0, mm1      ; OR them together</span><br></pre></td></tr></table></figure>

<h1 id="有符号数绝对值差"><a href="#有符号数绝对值差" class="headerlink" title="有符号数绝对值差"></a>有符号数绝对值差</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">psubw xmm0, xmm1 ; subtract words</span><br><span class="line">pabsw xmm1, xmm0 ; results in XMM1</span><br></pre></td></tr></table></figure>
<h1 id="绝对值"><a href="#绝对值" class="headerlink" title="绝对值"></a>绝对值</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pxor mm1, mm1</span><br><span class="line">psubw mm1, mm0</span><br><span class="line">pmaxsw mm1, mm0</span><br></pre></td></tr></table></figure>

<p>以上取绝对值的算法优点在于，消除了比较判断，避免BTB预测失败造成的开销</p>
<hr>
<h1 id="16位扩展成32位"><a href="#16位扩展成32位" class="headerlink" title="16位扩展成32位"></a>16位扩展成32位</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">movdqa     xmm1, xmm0</span><br><span class="line">punpcklwd  xmm0, xmm7 ; unpack the 4 low-end words into 4 32-bit doubleword</span><br><span class="line">punpckhwd  xmm1, xmm7 ; unpackthe4high-endwords into 4 32-bit doublewords</span><br></pre></td></tr></table></figure>
<p>数位的扩展和压缩是常见的操作，计算中间值往往超过原始像素8bit的数值范围</p>
<hr>
<h2 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h2><h3 id="数据局部性"><a href="#数据局部性" class="headerlink" title="数据局部性"></a>数据局部性</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">colsarray_bad</span><span class="params">(<span class="keyword">int</span> a[M][N])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i,j,sum=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(j = <span class="number">0</span>; j&lt;N; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i&lt;N; j++) &#123;</span><br><span class="line">      sum += a[i][j];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">colsarray_good</span><span class="params">(<span class="keyword">int</span> a[M][N])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i,j,sum=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i&lt;M; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span>(j = <span class="number">0</span>; j&lt;N; j++) &#123;</span><br><span class="line">      sum += a[i][j];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="hot-cold分离"><a href="#hot-cold分离" class="headerlink" title="hot-cold分离"></a>hot-cold分离</h3><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1giw8n9u48kj310o0n2abm.jpg"></p>
<hr>
<h2 id="Loop优化"><a href="#Loop优化" class="headerlink" title="Loop优化"></a>Loop优化</h2><h3 id="将Loop无关代码移到Loop体外，避免冗余计算"><a href="#将Loop无关代码移到Loop体外，避免冗余计算" class="headerlink" title="将Loop无关代码移到Loop体外，避免冗余计算"></a>将Loop无关代码移到Loop体外，避免冗余计算</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(str); i++&gt;) &#123;</span><br><span class="line">;;;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> len = <span class="built_in">strlen</span>(str);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++&gt;) &#123;</span><br><span class="line">;;;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Loop中避免判断"><a href="#Loop中避免判断" class="headerlink" title="Loop中避免判断"></a>Loop中避免判断</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">  <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">    FuncA(i);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    FuncB(i);</span><br><span class="line">  &#125;</span><br><span class="line">  FuncC(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i += <span class="number">2</span>) &#123;</span><br><span class="line">  FuncA(i);</span><br><span class="line">  FuncC(i);</span><br><span class="line">  FuncB(i+<span class="number">1</span>);</span><br><span class="line">  FuncC(i+<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="循环展开"><a href="#循环展开" class="headerlink" title="循环展开"></a>循环展开</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> <span class="built_in">list</span>[<span class="number">100</span>], sum = <span class="number">0.</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) sum += <span class="built_in">list</span>[i];</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">lea     esi,  list     ; list must be aligned by 16</span><br><span class="line">movapd  xmm0, [esi]    ; list[0], list[1]</span><br><span class="line">movapd  xmm1, [esi+16] ; list[2], list[3]</span><br><span class="line">add   esi, 800         ; Point to end of list</span><br><span class="line">mov eax, 32-800        ; Index to list[4] from end of list</span><br><span class="line">L1:</span><br><span class="line">addpd xmm0, [esi+eax]  ; Add list[i], list[i+1]</span><br><span class="line">addpd xmm1, [esi+eax+16];Add list[i+2], list[i+3]</span><br><span class="line">add eax,  32            ; i+&#x3D;4</span><br><span class="line">js</span><br><span class="line">addpd xmm0, xmm1        ;Add the two accumulators together</span><br><span class="line">movhlps xmm1, xmm0</span><br><span class="line">addsd xmm0, xmm1        ;Add the two vector elements</span><br><span class="line">movsd [sum], xmm0</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="问题指令集"><a href="#问题指令集" class="headerlink" title="问题指令集"></a>问题指令集</h1><ul>
<li>XCHG 强制cpu之间同步</li>
<li>Division=慢</li>
<li>MASKMOV 跳过cache直接写memory</li>
<li>INC/DEC 不会修改carry flag</li>
</ul>
<hr>
<h3 id="边界检查"><a href="#边界检查" class="headerlink" title="边界检查"></a>边界检查</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> <span class="built_in">list</span>[<span class="number">16</span>];</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line">....</span><br><span class="line"><span class="built_in">list</span>[i &amp; <span class="number">15</span>] += <span class="number">1.0f</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> min = <span class="number">100</span>, max = <span class="number">110</span>; <span class="keyword">int</span> i; ...</span><br><span class="line"><span class="keyword">if</span> (i &gt;= min &amp;&amp; i &lt;= max)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)(i - min) &lt;= (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(max - min))</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> a; <span class="keyword">bool</span> b;</span><br><span class="line">a = b ? <span class="number">1.5f</span> : <span class="number">2.6f</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> <span class="built_in">list</span>[<span class="number">300</span>];</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">300</span>; i++) &#123;</span><br><span class="line">  <span class="built_in">list</span>[i] = i % <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> a, b;</span><br><span class="line">a = b * <span class="number">1.2</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;n; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>( (lpDRV-&gt;dpCAPS) &amp; CLIPPING )</span><br><span class="line">    &#123;</span><br><span class="line">        DoOneThing(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( (lpDRV-&gt;dpCAPS) &amp; ALREADYCULLED )</span><br><span class="line">    &#123;</span><br><span class="line">        DoSomethingElse(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        DoYetAnotherThing(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( (lpDRV-&gt;dpCAPS) &amp; CLIPPING )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;n; i++)</span><br><span class="line">        &#123;</span><br><span class="line">          DoOneThing(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( (lpDRV-&gt;dpCAPS) &amp; ALREADYCULLED )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;n; i++)</span><br><span class="line">        &#123;</span><br><span class="line">          DoSomethingElse(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;n; i++)</span><br><span class="line">        &#123;</span><br><span class="line">          DoYetAnotherThing(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="汇编开发常见问题"><a href="#汇编开发常见问题" class="headerlink" title="汇编开发常见问题"></a>汇编开发常见问题</h1><ul>
<li>使用mmx指令后用emms清mm寄存器状态，因为mm寄存器和浮点寄存器是一套</li>
<li>寄存器状态。部分寄存器使用前必须保存状态，使用后恢复。EBX, ESI, EDI, EBP</li>
<li>push/pop操作必须匹配</li>
<li>计算前必须先统计数值范围，8bit/16bit/32bit，有符号/无符号<ul>
<li>[1 -5 20 20 -5 1] / 32</li>
</ul>
</li>
</ul>
<hr>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://www.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-optimization-manual.pdf">intel性能优化官方指南</a></p>
<p><a target="_blank" rel="noopener" href="https://www.agner.org/optimize/">agner个人主页</a></p>
<p><a target="_blank" rel="noopener" href="https://uops.info/table.html">微指令表</a></p>
<p><a target="_blank" rel="noopener" href="https://software.intel.com/content/www/us/en/develop/tools/vtune-profiler.html">vtune性能分析工具</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/1782e14a0766">gnu内联汇编</a></p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/X86_instruction_listings">X86指令集</a></p>
<p><a target="_blank" rel="noopener" href="https://software.intel.com/content/www/us/en/develop/articles/intel-architecture-code-analyzer.html">Intel Architecture Code Analyzer</a><br><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1giyjbzzakfj30y60j279i.jpg" alt="分析结果"><br><a target="_blank" rel="noopener" href="https://gist.github.com/nkurz/0bea9db0cff60ead1686#file-broadcast-c-L259">使用example</a></p>
<p><a target="_blank" rel="noopener" href="https://graphics.stanford.edu/~seander/bithacks.html">bithack</a></p>
<p><a target="_blank" rel="noopener" href="https://cs.nju.edu.cn/swang/CompArchOrg_13F/">Computer Architecture and Organization</a></p>
<p><a target="_blank" rel="noopener" href="http://aggregate.org/MAGIC/">magic</a></p>
<hr>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/09/14/2020-09-29-x86opt/" data-id="ckfzk9mjy0001nfrwb5x78b0p" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/09/29/2020-09-29-%E7%AC%AC%E4%B8%80%E7%AF%87/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          第一篇
        
      </div>
    </a>
  
  
    <a href="/2020/09/14/2020-10-07-%E6%8A%8A%E5%84%BF%E5%AD%90%E5%8F%98%E6%88%90%E7%94%B7%E5%AD%90%E6%B1%89/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">把儿子变成男子汉</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/10/08/%E4%B8%8D%E8%A6%81%E7%9D%80%E6%80%A5/">不要着急</a>
          </li>
        
          <li>
            <a href="/2020/10/07/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2020/09/29/2020-09-29-%E5%A5%B3%E5%84%BF%E9%80%89%E4%B8%8A%E7%BE%8E%E6%9C%AF%E8%AF%BE%E4%BB%A3%E8%A1%A8%E4%BA%86/">女儿选上课代表了！</a>
          </li>
        
          <li>
            <a href="/2020/09/29/2020-09-29-%E7%AC%AC%E4%B8%80%E7%AF%87/">第一篇</a>
          </li>
        
          <li>
            <a href="/2020/09/14/2020-09-29-x86opt/">x86 性能优化</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Peng Du<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>